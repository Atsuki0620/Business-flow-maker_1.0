# Business-flow-maker 開発計画書

---

## 0. 背景・目的・前提

- **目的**：マニュアル整備／システム開発要件整理に資する業務フローを、随時作成できる仕組みを用意する。
- **入力**：文章、業務文書、箇条書き、Excel 等（構造・非構造が混在）。
- **出力**：
  - 中間生成物：\*\*独自JSON（actors/phases/tasks/flows/issues 等）\*\*とHTML可視化（ブラウザ表示）。
  - 確定成果物：\*\*BPMN 2.0（XML/.bpmn）\*\*をブラウザで閲覧可能に（bpmn-js）。
  - PowerPoint（PPTX）：当面は**手動貼り付け**（SVG/PNG）で対応。自動化は後続フェーズで検討。
  - Excel（XLSX）：Actors/Tasks/Flows/RACI/Issues を表形式で出力。
- **利用者**：本人（個人利用が主）。業務規模は小～大まで想定（複数部署横断を含む）。
- **技術方針**：LLMは **OpenAI API / Azure OpenAI API** を使用。初期は**CLI/スクリプト中心**（UIやStreamlitは段階到達時に選定）。
- **正規化フロー**：**「2.正規化&クリーニング」工程はMVPでは省略**。必要性が高まった段で“オプション機能”として拡張可能にする。

---

## 1. 成果イメージ（二層構成）

- **レイヤー1（LLM親和の下書き）**：
  - LLMでテキストから**独自JSON**（actors/phases/tasks/flows/issues）を生成。
  - ブラウザで**静的HTML＋JS（ELK.js 等）**により、自動レイアウトしたSVGを表示。
  - JSON Schema検証・軽量な体裁チェック・**レビュー用チェックリスト**で品質を担保。
- **レイヤー2（BPMN準拠の確定形）**：
  - 独自JSONを**BPMN 2.0 XML**へ変換。
  - ブラウザで**bpmn-js**により`.bpmn`を表示・最終確認。
  - **bpmnlint**によるBPMNルールチェックを実施（違反箇所はテキスト出力）。
  - 画像（SVG/PNG）へ書き出し、**PPTへ貼付**。

---

## 2. スコープ（MVP → 強化）

### 2.1 MVPに含める

- 入力テキストの取り込み（複数ファイル結合可）
- LLMによる独自JSON生成（厳格スキーマ／不明はUNKNOWN）
- JSON Schema検証（構造・必須項目の欠落検出）
- HTML（ローカル静的）での可視化（ELK等の自動整列）
- JSON→BPMN変換（最小要素：lanes, tasks, exclusiveGateway, sequenceFlow）
- bpmn-js表示、bpmnlintチェック、SVG/PNG出力
- **レビュー用チェックリスト**の自動生成・出力

### 2.2 MVPに含めない（後続で検討）

- 入力の高度な正規化＆クリーニング（表記ゆれ、辞書、ID採番強化）
- UIフレームワーク固定（Streamlit等）／コラボ編集
- PPTX自動生成（python-pptx等）
- RAG（過去フロー・規程集）や社内用語辞書連携

---

## 3. 要件

### 3.1 機能要件

1. **独自JSON生成**：
   - actors, phases（5～7程度推奨）, tasks（入出力・責任・RACI・handoff\_to・systems・notes）, gateways, flows, issues。
   - 欠落・曖昧は `issues` に列挙。
2. **ブラウザ可視化（レイヤー1）**：
   - JSON読込 → 直感的SVGレイアウト（泳⾛レーン/縦積み）。
   - ノード/エッジの簡易検証（未参照ID、孤立ノード）。
3. **BPMN変換（レイヤー2）**：
   - lanes/laneSet、task、exclusiveGateway、sequenceFlow の出力。
   - bpmn-js での描画、bpmnlint でのルール検証。
4. **エクスポート**：SVG/PNGを出力し、PPT貼付に耐える解像度を確保。
5. **レビュー出力**：チェックリスト（本書 §8）とLint結果のサマリをテキストで出力。

### 3.2 非機能要件

- **再現性**：同じ入力で同等のJSON構造を返す（温度/プロンプト管理）。
- **可搬性**：ローカル実行可能（オフライン可視化、オンライン不要）。
- **拡張性**：正規化・PPT自動化・UI導入を後付け可能な構造。
- **セキュリティ**：機微情報はローカル保持。API送信前の匿名化オプションを留保。

---

## 4. 実装ステップ（マイルストーン）

**Phase 0：キックオフ**

- 入力サンプル3件を準備（匿名化）
- JSONスキーマ草案（actors/phases/tasks/flows/issues）を確定

**Phase 1：レイヤー1のMVP**

- LLM呼出しで独自JSON生成（JSONモード/関数呼び出し）
- JSON Schema検証＆エラーレポート
- HTML+JSでSVG可視化（elkjs等）
- レビュー用チェックリスト自動生成

**Phase 2：レイヤー2のMVP**

- JSON→BPMN 2.0 変換器（最小要素）
- bpmn-js 表示／bpmnlint ルール検証
- SVG/PNG書き出し→PPT貼付動線の確立

**Phase 3：改善サイクル**

- レイアウト調整（レーン幅/段組み/ラベル折返し）
- Lintルールのチューニング（例：未接続フロー、重複タスク名）
- 最低限の運用テンプレ（入力→確認→出力チェックリスト）整備

**Phase 4：任意拡張**（必要性が生じた場合のみ）

- 正規化&クリーニング機能の追加（表記ゆれ/ID採番/辞書）
- PPTX自動化（テンプレレイアウト）
- UI導入（要件確定後に選定、ブラウザorデスクトップ）
- RAG/社内辞書連携

---

## 5. 変更管理（リビングドキュメント運用）

- **バージョニング**：本書に版番号・日付・変更要約を記載。
- **意思決定ログ（ADR）**：主要な技術選択・スキーマ変更はADRに1件1ページで記録。
- **変更窓口**：本人利用のため簡素化。フェーズ移行時に差分レビューを実施。
- **ロールバック方針**：JSONスキーマの互換性を維持（旧→新のマイグレーションスクリプトを準備）。

---

## 6. 品質保証（QA）

- **テストデータ**：小・中・大の3サイズでサンプルを常備。
- **スナップショット**：独自JSONのゴールデンファイルを管理（差分検出）。
- **静的検証**：JSON Schema、未参照ID検出、循環/孤立タスク検出。
- **BPMN検証**：bpmnlintルールで最低限の準拠性確保。
- **可用性**：ローカルHTMLでの即時表示確認を標準フローに含める。

---

## 7. 成功指標（KPI/評価）

- **所要時間**：素材投入から下書き可視化（レイヤー1）まで◯分以内。
- **修正回数**：レイヤー1→レイヤー2移行時の手動修正点がN件以下。
- **Lint合格率**：bpmnlintの必須ルールに対する合格率 ≧ X%。
- **PPT作業時間**：SVG/PNG貼付後の整形時間 ≦ Y分。

---

## 8. レビュー用チェックリスト（運用時に毎回出力）

-

---

## 9. リスクと対策

- **LLMの幻覚（誤推測）**：不明はUNKNOWN出力を徹底、`issues` へ疑義を列挙、下書き段階（レイヤー1）で人手レビュー。
- **BPMN準拠不足**：レイヤー2でbpmnlintを強制、変換器の単体テストを整備。
- **レイアウト破綻**：elkjsの制約（ノード幅/折返し）を設定、長文はnotesに退避。
- **機密情報**：匿名化前処理（手動）を運用ルール化。API送信データの最小化。
- **要件変動**：リビングドキュメント運用＆ADRで変更を可視化、段階的機能フラグで影響限定。

---

## 10. 運用フロー（標準作業）

1. 素材収集（匿名化）
2. LLMで独自JSON生成（レイヤー1）
3. HTML表示で目視確認＋チェックリスト評価
4. 必要修正（JSONを直接修正 or 再生成）
5. JSON→BPMNへ変換（レイヤー2）
6. bpmn-js で目視確認＋bpmnlintで検証
7. SVG/PNGエクスポート→PPT貼付
8. 完成版のJSON/BPMN/画像を保管、ADR更新

---

## 11. 成果物・保管方針（MVP）

- **独自JSON**：`flow.json`（ゴールデン）
- **HTML可視化ファイル**：ローカルで開ける静的一式
- **BPMNファイル**：`flow.bpmn`
- **画像**：`flow.svg` / `flow.png`
- **レビュー記録**：チェックリスト結果、Lintログ、ADR

---

## 12. 次の一歩（実行トリガ）

- Phase 0/1を開始：サンプル3件で **レイヤー1のMVP** を完成させ、
  - JSONスキーマの妥当性
  - 可視化の視認性
  - チェックリストの有効性
    を確認。合格後、Phase 2（レイヤー2）へ進む。

---

**注記**：本計画書はフェーズ進行や要件変更に応じ、随時更新する（版番号・変更履歴を冒頭に追記）。

